clear all;
SNR_db = [0:30];
N=1e5;
M=4;

%convert SNR db to SNR
sig_energy = 10.^(SNR_db/10);
l = length(sig_energy);

%declare a matrix for SER
SER_SIM = zeros(1,l);

%generate array of original signal
mag1 = sqrt(sig_energy);

%generate array of original signal
mag2=transpose(0:0.2:2*M);
sig_ind=transpose([0:M]);
original_signal=exp(-1j*2*pi/M*(sig_ind)).*mag2;


x1=transpose(real(original_signal));
y1=transpose(imag(original_signal));

figure(1);
scatter(x1,y1,'r');

tran_signal = zeros(N,1);


for index=1:l
    %transmitted signals are selected randomly from the original signals
    tran_signal_index = randi(M,N,1);
    
    for row=1:N
        tran_signal(row,1)=original_signal(tran_signal_index(row,1),1);
    end
    
    x2=transpose(real(tran_signal));
    y2=transpose(imag(tran_signal));
    
    figure(2);
    scatter(x2,y2,'b');

    %generate white gaussian noise and normalise its power & fading channel
    noise =(randn(N,1)+1j*randn(N,1))./sqrt(2);
    h = (randn(N,1)+1j*randn(N,1))./sqrt(2);
    
    %received signal = transmitted signal * fading channel + noise
    receive_sig =mag1(index).*h.*tran_signal+noise;
   
    %detected signals are generated by mapping the transmitted signals to the
    %nearest signal after channel
    Eucld_dist=zeros(N,M);
    
    for k = 1: M
        Eucld_dist(:,k) = abs(receive_sig - mag1(index).*h.*original_signal(k,1) );
    end
    [~, indices ]       = min(Eucld_dist,[],2) ;
    number_of_errors    = (indices~=tran_signal_index);
    SER_SIM(index)          = mean(number_of_errors);
    
    
    
    %error_num = sum(detect'~=tran_signal_index);%error number is the number of difference
    %SER_SIM(1,index) = error_num;%total number of errors
    
end

%SER_SIM = SER_SIM./(N*log2(M));%average rate of errors


%SER_THEO = 1/2*(1 - sqrt(sig_energy./(sig_energy+1)));
figure();
semilogy(SNR_db,SER_SIM,'*r');
legend('SER simulated','Location','southwest');
str=sprintf('SER against SNR when M=%d',M);
title(str);
xlabel('SNR/db');
ylabel('SER');
grid on

